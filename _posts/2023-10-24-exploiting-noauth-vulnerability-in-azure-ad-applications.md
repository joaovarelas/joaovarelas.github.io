---
title: Exploiting nOAuth Vulnerability in Azure AD Applications 
author: vrls
date: 2023-10-24
#categories: [TOP_CATEGORIE, SUB_CATEGORIE]
tags: [oauth, openid, noauth, vulnerability, azure, ad, microsoft, entra, fusionauth, id, auth, authentication, authorization, poc, exploit]
image: /assets/img/posts/2023/10/790700654348c763d8e97d65604543496b0c56004747871e2a87c636c2ca5dd4.png #og:image
permalink: /posts/2023/10/exploiting-noauth-vulnerability-in-azure-ad-applications/
description: Discover the nOAuth vulnerability in Azure AD OAuth apps, enabling account takeover via email forgery. This guide demos exploitation using FusionAuth PoC, covering setup of multi-tenant apps, attacker impersonation techniques, impacts like auth bypass and privilege escalation, plus mitigations with immutable claims and MFA.
#image:
#  src: /assets/img/posts/YYYY/MM/MD5SUMHASH.png
#  width: 350   # in pixels
#  height: 350   # in pixels
---


<!-- ![image](/assets/img/posts/2023/10/790700654348c763d8e97d65604543496b0c56004747871e2a87c636c2ca5dd4.png) 

<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:domain" content="vrls.ws">
<meta property="twitter:url" content="https://vrls.ws/posts/2023/10/exploiting-noauth-vulnerability-in-azure-ad-applications/">
<meta name="twitter:title" content="Exploiting nOAuth Vulnerability in Azure AD Applications">
<meta name="twitter:description" content="Personal blog about computer hacking & security">
<meta name="twitter:image" content="https://vrls.ws/assets/img/posts/2023/10/790700654348c763d8e97d65604543496b0c56004747871e2a87c636c2ca5dd4.jpeg">

-->

## Introduction

The nOAuth vulnerability was originally discovered by [Descope](https://www.descope.com/blog/post/noauth) security team and impacts Microsoft Azure AD applications configured to use OAuth.

Essentially the vulnerability is a design flaw that can lead to account takeover when the application has "Login with Microsoft" button. An attacker may forge its own email address to match a victim address and as a consequence, the application will let the attacker sign in and impersonate the victim user.

For instance, Grafana patched this vuln and assigned [CVE-2023-3128](https://grafana.com/security/security-advisories/cve-2023-3128/). In this demo [FusionAuth](https://fusionauth.io/) application will be used as a Proof-of-Concept to demonstrate how to exploit the nOAuth vulnerability. FusionAuth is an Identity and Access Management (IAM) platform designed to simplify the implementation of secure authentication and authorization systems for web and mobile applications.


## Setup Azure AD 


Start by creating 2 distinct tenants in Azure AD. 

1. `noauthuser.onmicrosoft.com` - Legitimate tenant
2. `noauthattacker.onmicrosoft.com` - Attacker's tenant


![image](/assets/img/posts/2023/10/02d360f7670a4b02e143242cbe98931a13966ce4d5bc847c2e654fd1b5153536.png)


Create one user on each tenant (`victim` & `attacker` respectively):

![image](/assets/img/posts/2023/10/0054c328784215e335956bd9b85c96d8795b4eab0484ec6ec350d1ef15816367.png)


Register an application in Azure legitimate tenant. It will be used to configure a new IdP (OpenID) in FusionAuth.


![image](/assets/img/posts/2023/10/172766d46dfef863fdef4fc14f3e53c233f6bd51b73d62a1296510203490df9d.png)

Note that callback URL `http://` is only allowed because the hostname is `localhost`.  In reality, it would be mandatory to use TLS/HTTPS. The application is configured as multi-tenant for cross-tenant exploitation. Even though single-tenant apps are less likely to be exploited, they might still be _vulnerable_. As an exercise, reproduce the steps below and combine all the possible configurations for app types in Azure AD (single-tenant, multi-tenant, multi-tenant + personal accounts) & issuer URL authorities (such as `<tenant>`, `common`, `organizations` and `consumers`). 

Keep the client ID and client secret. Additionally, assign the respective user (`victim`) to access this application in Azure `Enterprise Applications` menu. Follow the [docs](https://fusionauth.io/docs/v1/tech/identity-providers/openid-connect/azure-ad) for step-by-step procedure. 




## Setup the Application


Run the FusionAuth application as a Docker container for convenience. Follow the Docker installation [guide](https://fusionauth.io/docs/v1/tech/installation-guide/docker).


![image](/assets/img/posts/2023/10/e89d5942b15dd25711333685a36050a4fe8b1829c74945e363ac573eaa2f6035.png)


The local FusionAuth app setup will look more or less like this:


![image](/assets/img/posts/2023/10/1903e12f88894c5d9a85ba6f34c48db321210fd620128102d58593ee5ba71037.png)


Admin web interface will be available at [http://localhost:9011/admin/setup-wizard](http://localhost:9011/admin/setup-wizard) once the Docker containers are up and running. Proceed to configure a local administrator and then create a new IdP (will use OpenID in this case).

![image](/assets/img/posts/2023/10/97dc126022c53d77718b8c6033258fe63855bcb84fe5c7c8e22ff05a10ae3f83.png)


![image](/assets/img/posts/2023/10/0f4d6000b3fa99ac3a81938de8f785e2b45512ec71d4cee42219740d0b8bb15c.png)


![image](/assets/img/posts/2023/10/9b6b8a162072dd1252f8287c3c102ab7463acff90594dce473f66966901a9125.png)



Once it has been configured, the "Login with Azure AD" button should appear below.




![image](/assets/img/posts/2023/10/b08c3f9ae7af095b60241b6cd826ae3e76b3ed48741ac866fac9aa99db559958.png)


![image](/assets/img/posts/2023/10/a0b6f119133bfb98b61d1432a9501bf0937bd789f99c993b8be1fa4a54bce137.png)


![image](/assets/img/posts/2023/10/c0c291ea1b396b2ece1059b23b1681216d635de4d39ff25ab992bb67d5b428ba.png)



After signing in, the error message indicates the user has been successfully registered but doesn't have access to FusionAuth administrator web interface. 

For demonstration purposes we'll assign `victim@noauthuser.onmicrosoft.com` to FusionAuth admins group since we don't have any 3rd-party application configured in FusionAuth.


![image](/assets/img/posts/2023/10/1d42ecf669a563b47eaa5dec092d918dfa6f1ba7c7fac810d81441db02be009c.png)


Going back to the panel as local admin `admin@fusionauth.local` we can assign the `victim` user to the admins group.


![image](/assets/img/posts/2023/10/2a1bbe5bd7aa85d128ff0ee770a7787e579e231911fbba6614f8f76a8e85123e.png)



Finally when we login once again as `victim`, we will be displayed the FusionAuth admin web interface.

![image](/assets/img/posts/2023/10/b08c3f9ae7af095b60241b6cd826ae3e76b3ed48741ac866fac9aa99db559958.png)


![image](/assets/img/posts/2023/10/929bc58d872a00517cb7ed28fad398f345390d274f30adc2c0e95bf3e1b2fccc.png)




## Exploitation


Now we have a working FusionAuth instance configured to authorize users from Azure AD.

The `attacker` might change his contact email address field in Azure AD to match the `victim` address. Once he tries to login, the application will _merge_ the account and let the `attacker` login into the `victim` account.

To exploit the nOAuth vulnerability:

![image](/assets/img/posts/2023/10/0585d738a6da256d919e7c88dd0fde76967399327246e0625ea2529cc90efb1a.png)


![image](/assets/img/posts/2023/10/964af9526761281eb60e00dd6bfc13ae41e3baf7a0fe4121b6a08edcf4ffa45e.png)


![image](/assets/img/posts/2023/10/5e1ba9e1c7d51a827d1ab5f3d8332f958857d7e866660095777a7c5123a9a8e3.png)



Vulnerability was successfully exploited and user `attacker` is now authenticated as `victim`ðŸ’¥.



## Impact 

- **Authentication bypass**: arbitrary users may log in into the application(s).

- **Account takeover**: the attacker can impersonate and compromise accounts of legitimate users.

- **Privilege escalation**: a regular user can escalate to a more privileged account.




## Mitigation

Microsoft suggests the use immutable fields as user identifier, such as  `sub` (subject) or `oid` (object id) claims, as they can't be modified or tampered. The use of `upn` is discouraged as it might change over time but its use does not leave the application vulnerable. A new optional claim `xms_edov` was introduced to indicate wheter the email domain owner has been verified.

Also enabling strong authentication mechanisms such as multi-factor authentication (MFA) helps prevent this vulnerability from being successfully exploited. Refer to nOAuth blog by Descope and official Microsoft advisory for more recommendations.

Additionally, FusionAuth already addressed this issue and made security enhacements ([#2423](https://github.com/FusionAuth/fusionauth-issues/issues/2423) and  [#2424](https://github.com/FusionAuth/fusionauth-issues/issues/2424)). You should update your FusionAuth instance to keep up with latest features.  

## Disclosure Timeline

- CVSS Severity Score: [7.1 - High](https://www.first.org/cvss/calculator/4.0#CVSS:4.0/AV:N/AC:L/AT:P/PR:L/UI:N/VC:L/VI:H/VA:N/SC:L/SI:H/SA:N)

- 2023-08-03: Vulnerability was discovered
- 2023-08-04: Sent vulnerability details to vendor (`security@fusionauth.io`)
- 2023-08-14: The vendor acknowledges the vulnerability
- 2023-08-18: New security enhacements
    - [https://github.com/FusionAuth/fusionauth-issues/issues/2423](https://github.com/FusionAuth/fusionauth-issues/issues/2423)
    - [https://github.com/FusionAuth/fusionauth-issues/issues/2424](https://github.com/FusionAuth/fusionauth-issues/issues/2424)
    - [https://github.com/FusionAuth/fusionauth-app/pull/304](https://github.com/FusionAuth/fusionauth-app/pull/304)
- 2023-10-21: New public release
- 2023-10-24: Public disclosure




## References

- [https://www.descope.com/noauth](https://www.descope.com/noauth)
- [https://msrc.microsoft.com/blog/2023/06/potential-risk-of-privilege-escalation-in-azure-ad-applications/](https://msrc.microsoft.com/blog/2023/06/potential-risk-of-privilege-escalation-in-azure-ad-applications/)
- [https://learn.microsoft.com/en-us/azure/active-directory/develop/claims-validation#validate-the-subject](https://learn.microsoft.com/en-us/azure/active-directory/develop/claims-validation#validate-the-subject)
- [https://fusionauth.io/docs/v1/tech/installation-guide/docker](https://fusionauth.io/docs/v1/tech/installation-guide/docker)
- [https://fusionauth.io/docs/v1/tech/identity-providers/openid-connect/azure-ad](https://fusionauth.io/docs/v1/tech/identity-providers/openid-connect/azure-ad)
- [https://github.com/FusionAuth/fusionauth-issues/issues/2423](https://github.com/FusionAuth/fusionauth-issues/issues/2423)
- [https://github.com/FusionAuth/fusionauth-issues/issues/2424](https://github.com/FusionAuth/fusionauth-issues/issues/2424)
- [https://github.com/FusionAuth/fusionauth-app/pull/304](https://github.com/FusionAuth/fusionauth-app/pull/304)




